apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: buildah-with-secret
spec:
  params:
    - name: IMAGE
      type: string
    - name: EDGE_VERSION
      type: string
    - name: TLSVERIFY
      type: string
    - name: GITHUB_CREDS_USR
      type: string
  workspaces:
    - name: source
    - name: dockerconfig
  steps:
    - name: build
      image: quay.io/buildah/stable
      env:
        - name: EDGE_VERSION
          value: $(params.EDGE_VERSION)
        - name: GITHUB_CREDS_USR
          value: $(params.GITHUB_CREDS_USR)
        - name: GITHUB_CREDS_PSW
          valueFrom:
            secretKeyRef:
              name: github-creds
              key: password
      script: |  
        #!/bin/sh
        buildah bud \
          --tls-verify=$(params.TLSVERIFY) \
          --build-arg EDGE_VERSION=$EDGE_VERSION \
          --build-arg GITHUB_CREDS_USR=$GITHUB_CREDS_USR \
          --build-arg GITHUB_CREDS_PSW=$GITHUB_CREDS_PSW \
          -t $(params.IMAGE) \
          $(workspaces.source.path)

---
apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: build-wx-mcp
spec:
  description: | 
    This pipeline builds an edge runtime with the WxMCPServer package as a container
  params:
  - name: repo-url
    type: string
  - name: image-reference
    type: string
  - name: edge-version
    type: string
  - name: github-user
    type: string
  workspaces:
  - name: shared-data
  - name: docker-credentials
  tasks:
  - name: fetch-builder
    taskRef:
      name: git-clone
    workspaces:
    - name: output
      workspace: shared-data
    params:
    - name: url
      value: $(params.repo-url)
  - name: build-push
    runAfter: ["fetch-builder"]
    taskRef:
      name: buildah-with-secret
    workspaces:
    - name: dockerconfig
      workspace: docker-credentials
    - name: source
      workspace: shared-data
    params:
    - name: IMAGE
      value: $(params.image-reference)
    - name: TLSVERIFY
      value: "false"
    - name: EDGE_VERSION
      value: $(params.edge-version)
    - name: GITHUB_CREDS_USR
      value: $(params.github-user)